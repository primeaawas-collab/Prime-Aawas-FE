image: amazon/aws-cli:2.15.0

pipelines:
  default:
    - step:
        name: Build and Conditional Deploy
        deployment: development
        oidc: true
        script:
          # -----------------------------
          # 0. Read commit message properly
          # -----------------------------
          - echo "ðŸ“ Commit message: $BITBUCKET_COMMIT_MESSAGE"
          - COMMIT_MSG="$BITBUCKET_COMMIT_MESSAGE"

          - |
            if echo "$COMMIT_MSG" | grep -iq "#deploy"; then
              echo "âœ… Deploy flag detected â€” running dev deployment..."
            else
              echo "â­ï¸ No deploy flag found â€” skipping deployment."
              exit 0
            fi

          # -----------------------------
          # 1. Assume AWS Role via OIDC
          # -----------------------------
          - echo "ðŸ”‘ Assuming AWS OIDC Role..."
          - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"
          - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
          - export AWS_DEFAULT_REGION=ap-south-1
          - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

          - aws sts get-caller-identity

          # -----------------------------
          # 2. Run your deploy script
          # -----------------------------
          - chmod +x deploy.sh
          - ./deploy.sh

  branches:
    master:
      - step:
          name: Deploy to AWS (S3 + CloudFront)
          deployment: development
          oidc: true
          script:
            - echo "ðŸ”‘ Assuming AWS OIDC Role..."
            - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"
            - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
            - export AWS_DEFAULT_REGION=ap-south-1
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"
            - aws sts get-caller-identity
            - chmod +x deploy.sh
            - ./deploy.sh

  tags:
    "v*":
      - step:
          name: Deploy to AWS (Production)
          deployment: production
          oidc: true
          script:
            - echo "ðŸš€ Deploying for release tag: $BITBUCKET_TAG"
            - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"
            - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
            - export AWS_DEFAULT_REGION=ap-south-1
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"
            - aws sts get-caller-identity
            - chmod +x deploy.sh
            - ./deploy.sh prod
