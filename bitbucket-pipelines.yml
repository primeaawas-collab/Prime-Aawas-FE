image: amazon/aws-cli:2.15.0

pipelines:
  default:
    - step:
        name: Build and Conditional Deploy
        deployment: development
        oidc: true     # ðŸ‘ˆ Enables OpenID Connect token exchange
        script:
            - apt-get update && apt-get install -y git bash
            - 'COMMIT_MSG=$(git log -1 --pretty=%B)'
            - 'echo "Last commit message: $COMMIT_MSG"'
            - |
              if echo "$COMMIT_MSG" | grep -iq "#deploy"; then
                echo "Deploy flag detected â€” running dev deployment..."
              else
                echo "No deploy flag found â€” skipping deployment."
                exit 0
              fi
            # -----------------------------
            # 1. Assume the AWS IAM Role using OIDC
            # -----------------------------
            - echo "ðŸ”‘ Assuming AWS OIDC Role..."
            - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"
            - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
            - export AWS_DEFAULT_REGION=ap-south-1  # or your region

            # Bitbucket automatically injects OIDC token as BITBUCKET_STEP_OIDC_TOKEN
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            # Verify AWS identity (optional)
            - aws sts get-caller-identity

            # -----------------------------
            # 2. Run your deployment script
            # -----------------------------
            - chmod +x deploy.sh
            - ./deploy.sh

  branches:
    master:
      - step:
          name: Deploy to AWS (S3 + CloudFront)
          deployment: development
          oidc: true     # ðŸ‘ˆ Enables OpenID Connect token exchange
          script:
            # -----------------------------
            # 1. Assume the AWS IAM Role using OIDC
            # -----------------------------
            - echo "ðŸ”‘ Assuming AWS OIDC Role..."
            - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"   # ðŸ‘ˆ replace with your role ARN
            - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
            - export AWS_DEFAULT_REGION=ap-south-1  # or your region

            # Bitbucket automatically injects OIDC token as BITBUCKET_STEP_OIDC_TOKEN
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            # Verify AWS identity (optional)
            - aws sts get-caller-identity

            # -----------------------------
            # 2. Install dependencies if needed
            # -----------------------------
            - apt-get update && apt-get install -y bash

            # -----------------------------
            # 3. Run your deployment script
            # -----------------------------
            - chmod +x deploy.sh
            - ./deploy.sh

  tags:
    "v*":
      - step:
          name: Deploy to AWS (Production)
          deployment: production
          oidc: true
          script:
            - echo "ðŸš€ Deploying for release tag: $BITBUCKET_TAG"
            # -----------------------------
            # 1. Setup AWS OIDC credentials
            # -----------------------------
            - export AWS_ROLE_ARN="${AWS_ROLE_ARN}"
            - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
            - export AWS_DEFAULT_REGION=ap-south-1
            - echo "$BITBUCKET_STEP_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            - aws sts get-caller-identity

            # -----------------------------
            # 2. Run deployment script
            # -----------------------------
            - chmod +x deploy.sh
            - ./deploy.sh prod