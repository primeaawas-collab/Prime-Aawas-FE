AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFront distribution with OAC, custom domain, and recommended cache policies for an existing Primeaawas app bucket

Parameters:
  BucketName:
    Type: String
    Description: Existing private S3 bucket name hosting the Primeaawas Angular app

  DomainName:
    Type: String
    Description: Custom domain name for CloudFront

  AcmCertificateArn:
    Type: String
    Description: ACM certificate ARN (must be in us-east-1 region for CloudFront)

Resources:
  # -------------------------
  # Origin Access Control (OAC)
  # -------------------------
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: Primeaawas-OAC
        Description: OAC for CloudFront to access S3 privately
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # -------------------------
  # CloudFront Distribution
  # -------------------------
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: CloudFront Distribution for Primeaawas Angular app
        DefaultRootObject: index.html

        Aliases:
          - !Ref DomainName

        Origins:
          - Id: PrimeaawasS3Origin
            DomainName: !Sub "${BucketName}.s3.amazonaws.com"
            S3OriginConfig: {}
            OriginAccessControlId: !Ref CloudFrontOAC

        DefaultCacheBehavior:
          TargetOriginId: PrimeaawasS3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET", "HEAD", "OPTIONS"]
          Compress: true

          # âœ… AWS-managed policies (public IDs)
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6     # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf # CORS-S3Origin
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03 # SecurityHeadersPolicy

        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html

        ViewerCertificate:
          AcmCertificateArn: !Ref AcmCertificateArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021

        HttpVersion: http2
        PriceClass: PriceClass_100

  # -------------------------
  # Updated OAC-style Bucket Policy
  # -------------------------
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref BucketName
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontOACAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${BucketName}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

Outputs:
  CloudFrontURL:
    Description: CloudFront Distribution URL
    Value: !Sub "https://${DomainName}"

  CloudFrontDistributionId:
    Description: CloudFront Distribution ID (used for cache invalidation)
    Value: !Ref CloudFrontDistribution